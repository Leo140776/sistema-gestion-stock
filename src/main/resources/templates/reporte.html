<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reportes de Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .container { 
            max-width: 1200px; 
            margin-top: 30px; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        }
        .table-header { background-color: #343a40; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Reportes de Movimientos</h2>
        <a th:href="@{/}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Inicio
        </a>
    </div>

    <div class="card p-3 mb-4 bg-light border-0">
        <form th:action="@{/reportes}" method="get" class="row g-3 align-items-end" id="formFiltros">
            
            <div class="col-md-2">
                <label class="form-label fw-bold">Fecha Inicio:</label>
                <input type="date" class="form-control" name="fechaInicio" th:value="${param.fechaInicio}">
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Fecha Fin:</label>
                <input type="date" class="form-control" name="fechaFin" th:value="${param.fechaFin}">
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">Tipo:</label>
                <select class="form-select" name="tipo" id="tipoSelect" onchange="actualizarMotivos()">
                    <option value="">Todos</option>
                    <option value="INGRESO" th:selected="${param.tipo != null && param.tipo.toString() == 'INGRESO'}">Ingreso</option>
                    <option value="EGRESO" th:selected="${param.tipo != null && param.tipo.toString() == 'EGRESO'}">Egreso</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Motivo:</label>
                <select class="form-select" name="motivo" id="motivoSelect" onchange="actualizarProductos()">
                    <option value="">Todos</option>
                    </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Producto:</label>
                <select class="form-select" name="productoId" id="productoSelect">
                    <option value="">Todos los productos</option>
                    <option th:each="prod : ${productos}" 
                            th:value="${prod.id}" 
                            th:text="${prod.nombre}" 
                            th:selected="${param.productoId != null && param.productoId.toString() == prod.id.toString()}">
                    </option>
                </select>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2 mt-3">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-search"></i> Filtrar Resultados
                </button>
                
                <a href="#" onclick="descargarExcel(event)" class="btn btn-success px-4">
                   <i class="bi bi-file-earmark-excel-fill"></i> Exportar Excel
                </a>
            </div>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-header">
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Motivo</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="t : ${transacciones}">
                    <td th:text="${#temporals.format(t.fecha, 'dd/MM/yyyy HH:mm')}"></td>
                    <td>
                        <span th:if="${t.tipo.name() == 'INGRESO'}" class="badge bg-success">INGRESO</span>
                        <span th:if="${t.tipo.name() == 'EGRESO'}" class="badge bg-danger">EGRESO</span>
                    </td>
                    <td th:text="${t.producto != null ? t.producto.nombre : 'Eliminado'}"></td>
                    <td th:text="${t.cantidad}" class="fw-bold text-center"></td>
                    
                    <td th:text="${t.motivo == 'Producción' ? 'Producción/Fabricación' : t.motivo}"></td>
                    
                    <td th:text="${t.observaciones != null ? t.observaciones : ''}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(transacciones)}">
                    <td colspan="6" class="text-center text-muted py-3">
                        No se encontraron movimientos con los filtros seleccionados.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
    
    // CORREGIDO: "Otro" en singular para que coincida con tu Base de Datos
    const motivosIngreso = ["Producción", "Devolución", "Ajuste Inventario", "Otro"];
    const motivosEgreso = ["Venta", "Rotura", "Desperdicio", "Ajuste Inventario", "Donación"];

    const motivoPrevio = /*[[${param.motivo}]]*/ '';
    const productoPrevio = /*[[${param.productoId}]]*/ '';

    function actualizarMotivos() {
        const tipo = document.getElementById("tipoSelect").value;
        const motivoSelect = document.getElementById("motivoSelect");
        const valorActual = motivoSelect.value || (motivoPrevio ? motivoPrevio[0] : "");

        motivoSelect.innerHTML = '<option value="">Todos</option>';
        
        let opciones = [];
        if (tipo === "INGRESO") opciones = motivosIngreso;
        else if (tipo === "EGRESO") opciones = motivosEgreso;
        else opciones = [...new Set([...motivosIngreso, ...motivosEgreso])];

        opciones.forEach(m => {
            let option = document.createElement("option");
            option.value = m; // Valor que se envía al servidor
            
            // TRUCO VISUAL: Mostramos el texto amigable
            if (m === "Producción") {
                option.text = "Producción/Fabricación";
            } else {
                option.text = m;
            }

            if (m === valorActual) option.selected = true;
            motivoSelect.appendChild(option);
        });
        
        actualizarProductos();
    }

    function actualizarProductos() {
        const tipo = document.getElementById("tipoSelect").value;
        const motivo = document.getElementById("motivoSelect").value;
        const productoSelect = document.getElementById("productoSelect");

        const motivoEncoded = encodeURIComponent(motivo);

        fetch(`/api/productos-filtrados?tipo=${tipo}&motivo=${motivoEncoded}`)
            .then(response => response.json())
            .then(data => {
                productoSelect.innerHTML = '<option value="">Todos los productos</option>';
                data.forEach(prod => {
                    let option = document.createElement("option");
                    option.value = prod.id;
                    option.text = prod.nombre;
                    
                    if (productoPrevio && prod.id == productoPrevio[0]) {
                        option.selected = true;
                    }
                    productoSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error cargando productos:', error));
    }

    function descargarExcel(event) {
        event.preventDefault();
        const params = new URLSearchParams(new FormData(document.getElementById("formFiltros"))).toString();
        window.location.href = `/reportes/exportar?${params}`;
    }

    document.addEventListener("DOMContentLoaded", function() {
        actualizarMotivos();
        setTimeout(actualizarProductos, 100); 
    });
</script>

</body>
</html>